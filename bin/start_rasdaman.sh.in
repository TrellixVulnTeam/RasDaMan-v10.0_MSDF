#!/bin/bash
#
# This file is part of rasdaman community.
#
# Rasdaman community is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Rasdaman community is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with rasdaman community.  If not, see <http://www.gnu.org/licenses/>.
#
# Copyright 2003 - 2017 Peter Baumann /
# rasdaman GmbH.
#
# For more information please see <http://www.rasdaman.org>
# or contact Peter Baumann via <baumann@rasdaman.com>.      
#

#
# start_rasdaman.sh - start rasdaman server complex
#
# SYNTAX
#    start_rasdaman.sh [servers...]
#
# DESCRIPTION
#    This script starts rasdaman.
#    Which rasdaman servers are started depends on the 'server' name(s) provided:
#    * If no server name is provided then the environment variable $RASSERVERS is
#      inspected to obtain a list of servers to be started. If $RASSERVERS is not
#      set, then all rasdaman servers defined will be attempted to start.
#    * If at least one parameter is provided then all parameters
#      will be treated as a server name which is tried to be started.
#
#    One possible reason while not all servers may come up is that more servers
#    might be defined than your licence model allows to run in parallel.
#
#    To log in to the server, the external variable $RASLOGIN is expected to hold
#    an ID string (see rasdaman manual). If not found, a desperate last attempt is
#    made to login as rasadmin/rasadmin. If this fails, no servers are started at all.
#
# PRECONDITIONS
#    - need to have a rasdaman admin login either from $RASLOGIN or as rasadmin/rasadmin
#    - need to run with an effective user id that allows to write into log/
#    - need to have a valid rasdaman installation
#

# get script name
PROG=`basename $0`

# RETURN CODES
RC_OK=0        # everything went fine
RC_ERROR=1    # something went wrong

# --- CONSTANTS -----------------------------------------------------

RASMGR_PORT=7001
# rasadmin/rasadmin
DEFAULT_RASCONTROL_LOGIN=rasadmin:d293a15562d3e70b6fdc5ee452eaed40

# error messages:
ERROR_PARAM="ERS001 Error: illegal parameter: $1"

# base DBMS used by petascope
PETASCOPEDB=@petascopedb@

log()
{
  echo "$PROG: $*"
}

logn()
{
  echo -n "$PROG: $*"
}

# Read the property of a value by input key from input properties file
get_property_value() {
    # $1 is path to input properties file (e.g: /opt/rasdaman/etc/petascope.properties).
    # $2 is the key of a property in this file which needs to get the value of this key.
    local -r properties_file="$1"
    local -r key="$2"

    # only grep key=value line not commented line (e.g: #key=value)
    grep "^$key=" "$properties_file" | sed -e 's/.*=//' -e 's/^[ \t]*//'
} 

log "starting rasdaman server complex..."

# --- start rasmgr: -------------------------------------------------

# here we want to put all log files
cd @logdir@

# check if we can actually write anything here
if [ ! -w . ]
then
    log "User $USER has no write permissions in @logdir@, rasdaman cannot be started." >&2
    exit $RC_ERROR
fi

# check if rasmgr exists
if [ ! -f @bindir@rasmgr ];
then
    log "rasmgr does not exist in "@bindir@", rasdaman cannot be started."
    exit $RC_ERROR
fi

# clear previous log file
rm -f nohup.out

# start rasdaman server manager as demon; log will go into nohup.out
# the manager is started in quiet mode
nohup @bindir@rasmgr --port $RASMGR_PORT & 2>&1
rasmgr_pid=$!

# --- start servers: -------------------------------------------------

# check if rasmgr's pid is actually running; if not, exit with an error.
# we do it this way, because the exit code cannot be captured with nohup
ps -p $rasmgr_pid > /dev/null
if [ $? -ne 0 ]; then
    log "rasmgr failed starting; please check the logs for more information."
    exit $RC_ERROR
fi

# these servers will be started:
if [ -n "$1" ]
then
    # parameters provided, take them as server names
    # B: check if parameter's name does not start with -- then it is the server name
    SERVERS=""
    for var in "$@"
    do
        if [[ "$var" != *"--"* ]]; then
            # this is server name so add to SERVERS
            SERVERS+="$var"' '
        fi
    done

else
    if [ -n "$RASSERVERS" ]; then
        SERVERS=$RASSERVERS
    else
        SERVERS=""
    fi
fi

# determine rascontrol login
if [ -z "$RASLOGIN" ]; then
    export RASLOGIN=$DEFAULT_RASCONTROL_LOGIN
fi

# ...then spawn server workers
if [ "$SERVERS" ]; then
    for SRV in $SERVERS
    do
        logn "starting server $SRV..."
        @bindir@rascontrol --port $RASMGR_PORT -e -q -x up srv $SRV || exit $!
    done
else
    log "starting all rasdaman servers..."
    @bindir@rascontrol --port $RASMGR_PORT -e -q -x up srv -all || exit $!
fi

# do a rasql query test to check if rasdaman has started properly
sleep 0.1 || sleep 1
@bindir@rasql -q 'select version()' --quiet -p $RASMGR_PORT > /dev/null 2>&1
if [ $? -ne 0 ]; then
    log "failed starting rasservers; please check the logs for more information."
    logn "shutting down rasdaman... "
    # shut down any rasservers just in case
    @bindir@rascontrol --port $RASMGR_PORT -e -q -x down srv -all -kill
    sleep $WAIT_FOR_CHILDREN
    # kill rasmgr
    @bindir@rascontrol --port $RASMGR_PORT -e -q -x down host -all -kill
    exit $RC_ERROR
fi

#------start embedded petascope/secore if needed--------------------------
log_path="@logdir@"
# war files also copied to this share folder: /opt/rasdaman/share/rasdaman/war/
war_path="@pkgdatadir@/war"
petascope_properties_path="@sysconfdir@/petascope.properties"
secore_properties_path="@sysconfdir@/secore.properties"

start_embedded() {
    # Start embedded tomcat from values in properties file
    # $1: the path to properties file (e.g: /opt/rasdaman/etc/petascope.properties).
    # $2: the web application name (e.g: petascope, secore).
    # $3: the war file of application (e.g: rasdaman.war, def.war).
    local -r properties_file_path="$1"
    local -r application_name="$2"
    local -r war_file_name="$3"  

    if [ -f "$properties_file_path" ]; then
        # check if java-server is embedded/external
        java_server=$(get_property_value "$properties_file_path" "java_server")
        # check if java-server is embedded
        if [ "$java_server" == "embedded" ]; then
            # Get the embedded port for server
            server_port=$(get_property_value "$properties_file_path" "server.port")
            # Check if port is available
            fuser -s -n tcp "$server_port"   
             # Return 1 means port is available  
            if [[ ! $? -eq 0 ]]; then
                nohup java -jar "$war_path/""$war_file_name" & 2>&1
                log "embedded $application_name is starting on port '$server_port'..."
                log "check $log_path/$application_name.log for detail."
            else
                log "port '$server_port' is occupied, cannot start embedded $application_name."
                exit $RC_ERROR
            fi
        fi
    else
        log "could not find properties file '$properties_file_path' to start embedded $application_name."
        exit $RC_ERROR
    fi
}

# Check if it should start embedded tomcat, secore
start_embedded "$secore_properties_path" "secore" "def.war"
start_embedded "$petascope_properties_path" "petascope" "rasdaman.war"

echo "done."
exit $RC_OK

# --- END ACTION ----------------------------------------------------

